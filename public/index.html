<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ë²•ë¥  í€´ì¦ˆ</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family: 'Inter', 'Noto Sans KR', Arial, sans-serif; margin:0; padding:0; }
.modal-overlay { background-color: rgba(0,0,0,0.5); transition: opacity 0.3s ease-in-out; }
</style>
<script>
tailwind.config = {
    theme: { extend: { colors: { 'primary':'#1976d2','primary-dark':'#1565c0','correct':'#4caf50','wrong':'#f44336','bg-light':'#f0f2f5' } } }
}
</script>
</head>
<body class="bg-bg-light min-h-screen p-4 flex justify-center items-start">

<div id="quiz-container" class="max-w-xl w-full mx-auto mt-5 p-6 md:p-8 bg-white rounded-xl shadow-2xl relative border border-gray-100">

    <div class="flex justify-between items-center mb-4 relative h-10">
        <button id="review-button" class="px-3 py-1 text-sm font-semibold text-white bg-primary hover:bg-primary-dark rounded-lg transition duration-200 shadow-md">ì˜¤ë‹µ ë³µìŠµ</button>
        <div class="flex flex-col items-end space-y-1">
            <div id="timer" class="text-xl font-bold text-gray-700">0</div>
            <div id="wrong-count" class="text-sm font-semibold text-wrong">ì˜¤ë‹µ: 0</div>
        </div>
    </div>

    <div id="question-text" class="mt-8 mb-6 text-lg font-medium text-gray-800 leading-relaxed min-h-[4rem]">
        {ì§ˆë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.}
    </div>

    <div id="options-container" class="space-y-3"></div>

    <div id="explanation-area" class="mt-4 p-4 text-sm bg-blue-50 border-l-4 border-primary rounded-lg text-gray-700 hidden transition-all duration-300"></div>

    <button id="next-button" class="w-full mt-6 py-3 border-none rounded-lg bg-primary text-white text-base font-semibold cursor-pointer hover:bg-primary-dark transition duration-200 shadow-lg hover:shadow-xl">ë‹¤ìŒ ë¬¸ì œ</button>
</div>

<div id="review-modal" class="fixed inset-0 flex items-center justify-center modal-overlay opacity-0 pointer-events-none z-50 transition duration-300">
    <div class="bg-white rounded-xl w-11/12 max-w-2xl max-h-[80vh] overflow-y-auto p-6 shadow-2xl transform scale-95 transition-transform duration-300">
        <h2 class="text-xl font-bold mb-4 border-b pb-2 text-gray-800">ì˜¤ë‹µ ë³µìŠµ ëª©ë¡</h2>
        <div id="review-list" class="space-y-3"></div>
        <button id="review-close" class="mt-6 w-full py-2 bg-wrong text-white font-semibold rounded-lg hover:bg-red-700 transition duration-200 shadow-md">ë‹«ê¸°</button>
    </div>
</div>

<script type="module">
/* =========================
   í†µí•© íŒ¨ì¹˜ ìŠ¤í¬ë¦½íŠ¸ â€” index.html ë‚´ ì´ ë¸”ë¡ìœ¼ë¡œ êµì²´
   - ì ˆëŒ€ quiz.article.lawName í‘œì‹œ ë¼ì¸ì€ ë³€ê²½í•˜ì§€ ì•ŠìŒ
   ========================= */

let allQuizzes = [], currentQuizIndex = 0, correctCount = 0, wrongQuizzes = [];
const questionTextEl = document.getElementById("question-text");
const optionsContainerEl = document.getElementById("options-container");
const explanationAreaEl = document.getElementById("explanation-area");
const nextButtonEl = document.getElementById("next-button");
const reviewButtonEl = document.getElementById("review-button");
const reviewModalEl = document.getElementById("review-modal");
const reviewListEl = document.getElementById("review-list");
const reviewCloseEl = document.getElementById("review-close");
const timerEl = document.getElementById("timer");
const wrongCountEl = document.getElementById("wrong-count");
let timerInterval;

// ----- ìœ í‹¸: ì•ˆì „í•œ ê°’ ë³´ì¥(normalize) -----
function normalizeServerQuiz(raw, fallbackIndex=0){
    // raw may contain different shapes from server. create canonical quiz object:
    const quiz = {};
    quiz.id = raw.id ?? raw._id ?? Date.now() + fallbackIndex;
    quiz.question = raw.question?.toString?.().trim() || (raw.prompt?.toString?.().trim()) || "ì§ˆë¬¸ í…ìŠ¤íŠ¸ ì—†ìŒ";
    // ensure article object exists with lawName property because UI expects quiz.article.lawName
    quiz.article = raw.article && raw.article.lawName ? { lawName: raw.article.lawName } :
                   (raw.source_law_name ? { lawName: raw.source_law_name } :
                   (raw.lawName ? { lawName: raw.lawName } : { lawName: "ë²•ë¥  ìƒì‹" }));
    // options: ensure array of {text, is_correct:boolean}
    const rawOptions = Array.isArray(raw.options) ? raw.options : (raw.choices || []);
    quiz.options = rawOptions.map(o => ({
        text: (o.text ?? o.choice ?? "").toString(),
        is_correct: (o.is_correct === true) || (o.is_correct === "true") || (o.isCorrect === true) || (o.correct === true) || false
    }));
    // ensure at least 2-4 options (do not invent options, but keep what's provided)
    if (!Array.isArray(quiz.options) || quiz.options.length === 0) {
        // fallback single-answer representation
        quiz.options = [
            { text: raw.answer ?? "ì •ë‹µ", is_correct: true },
            { text: "ë³´ê¸° 2", is_correct: false },
            { text: "ë³´ê¸° 3", is_correct: false }
        ];
    }
    quiz.answer = raw.answer ?? (quiz.options.find(o=>o.is_correct)?.text) ?? "ì •ë‹µ ì •ë³´ ì—†ìŒ";
    quiz.explanation = raw.explanation ?? raw.explain ?? "";
    quiz.timer_sec = Number.isInteger(raw.timer_sec) ? raw.timer_sec : (parseInt(raw.timer_sec) || 15);
    return quiz;
}

// ----- wrongQuizzes ë¡œì»¬ ì €ì¥/ë³µì› (í•­ìƒ ì •ê·œí™”í•´ì„œ ì €ì¥) -----
const STORAGE_KEY_WRONG = "wrongQuizzes";
function loadWrongQuizzes(){
    try{
        const raw = JSON.parse(localStorage.getItem(STORAGE_KEY_WRONG) || "[]");
        wrongQuizzes = Array.isArray(raw) ? raw.map((q, i) => normalizeServerQuiz(q, i)) : [];
    }catch(e){
        wrongQuizzes = [];
    }
    updateWrongCount();
}
function saveWrongQuizzes(){
    try{
        // store minimal canonical fields to avoid big objects
        const toStore = wrongQuizzes.map(q => ({
            id: q.id,
            question: q.question,
            article: q.article,
            options: q.options,
            answer: q.answer,
            explanation: q.explanation,
            timer_sec: q.timer_sec,
            selectedAnswer: q.selectedAnswer ?? null
        }));
        localStorage.setItem(STORAGE_KEY_WRONG, JSON.stringify(toStore));
    }catch(e){}
}

// ----- ë¡œì»¬ ìºì‹œ of allQuizzes (fallback) -----
const STORAGE_KEY_QUIZZES = "cached_quizzes_v1";
function saveQuizzesCache(){
    try{ localStorage.setItem(STORAGE_KEY_QUIZZES, JSON.stringify(allQuizzes)); }catch(e){}
}
function loadQuizzesCache(){
    try{ const raw = JSON.parse(localStorage.getItem(STORAGE_KEY_QUIZZES)||"[]"); return Array.isArray(raw) ? raw.map((q,i)=>normalizeServerQuiz(q,i)) : []; }catch(e){ return []; }
}

// ----- fetch ìƒˆ ì„¸íŠ¸ í•¨ìˆ˜ (ìºì‹œ ìš°íšŒ, ì•ˆì „í•œ ì •ê·œí™”) -----
async function fetchNewSet({ force=false } = {}){
    const base = "/api/quizzes";
    const url = force ? `${base}?refresh=1&ts=${Date.now()}` : `${base}?ts=${Date.now()}`;
    // UI feedback: disable next/review while loading
    nextButtonEl.disabled = true;
    reviewButtonEl.disabled = true;
    questionTextEl.textContent = "ğŸ”„ ìƒˆ ë¬¸ì œ ì„¸íŠ¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
    try{
        const res = await fetch(url, { method: "GET", cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) throw new Error("ì„œë²„ì—ì„œ ë¬¸ì œë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        allQuizzes = data.map((r,i) => normalizeServerQuiz(r,i));
        // reset progress for new set but preserve wrongQuizzes
        currentQuizIndex = 0;
        correctCount = 0;
        saveQuizzesCache();
        // show first question
        showQuiz();
    }catch(err){
        console.error("fetchNewSet ì‹¤íŒ¨:", err);
        // fallback to local cache if exists
        const cached = loadQuizzesCache();
        if (cached && cached.length){
            allQuizzes = cached;
            currentQuizIndex = 0;
            correctCount = 0;
            showQuiz();
            questionTextEl.insertAdjacentHTML("afterbegin","<div class='text-sm text-red-500'>[ì£¼ì˜] ì„œë²„ ë¡œë“œ ì‹¤íŒ¨ â€” ë¡œì»¬ ìºì‹œ ì‚¬ìš©</div>");
        } else {
            questionTextEl.textContent = "í€´ì¦ˆë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” ì„œë²„ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
        }
    } finally {
        reviewButtonEl.disabled = false;
    }
}

// ----- ê¸°ì¡´ loadQuizzes: ì´ˆê¸° ë¡œë“œ (uses cache first, then fetch) -----
async function loadQuizzes(){
    loadWrongQuizzes();
    // try local cache first
    const cached = loadQuizzesCache();
    if (cached.length){
        allQuizzes = cached;
        currentQuizIndex = 0;
        correctCount = 0;
        showQuiz();
        // also in background try to refresh silently
        fetchNewSet({ force:false }).catch(()=>{});
        return;
    }
    // otherwise fetch fresh
    await fetchNewSet({ force:true });
}

// ----- showQuiz (DO NOT CHANGE YOUR lawName DISPLAY LINE) -----
function showQuiz(){
    clearInterval(timerInterval);
    const quiz = allQuizzes[currentQuizIndex];
    if (!quiz){
        console.warn("í€´ì¦ˆ ì—†ìŒ");
        questionTextEl.textContent = "í‘œì‹œí•  í€´ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤.";
        return;
    }

    // NOTE: user insisted quiz.article.lawName display must not be altered â€” keep it
    questionTextEl.innerHTML = `<span class="text-sm font-light text-gray-500 mr-2">[${currentQuizIndex+1}/${allQuizzes.length}]</span>
    <span class="text-primary font-bold mr-2">(${quiz.article.lawName || 'ë²•ë¥  ìƒì‹'})</span>${quiz.question}`;

    optionsContainerEl.innerHTML = "";
    explanationAreaEl.classList.add("hidden");
    explanationAreaEl.textContent = "";
    nextButtonEl.disabled = true;
    nextButtonEl.classList.add("opacity-50","cursor-not-allowed");
    nextButtonEl.classList.remove("hover:bg-primary-dark");

    quiz.options.forEach((opt, index)=>{
        const btn = document.createElement("button");
        btn.className = `option-button w-full text-left p-4 border border-gray-300 rounded-xl cursor-pointer bg-white hover:bg-gray-50 transition duration-150 shadow-sm text-gray-700 font-medium`;
        btn.textContent = `${index+1}. ${opt.text}`;
        btn.dataset.isCorrect = opt.is_correct ? "true" : "false";
        btn.addEventListener("click", ()=> checkAnswer(btn, quiz));
        optionsContainerEl.appendChild(btn);
    });

    startTimer(Number.isInteger(quiz.timer_sec) ? quiz.timer_sec : 15);
}

// ----- checkAnswer -----
function checkAnswer(btn, quiz){
    clearInterval(timerInterval);
    const correct = btn.dataset.isCorrect === "true";
    quiz.selectedAnswer = btn.textContent.replace(/^\d+\.\s*/,"");

    Array.from(optionsContainerEl.children).forEach(b=>{
        b.disabled = true;
        b.classList.add("cursor-default");
        b.classList.remove("hover:bg-gray-50");
        if (b.dataset.isCorrect === "true"){
            b.classList.add("bg-correct","text-white","border-correct","shadow-md");
            b.classList.remove("bg-white","text-gray-700","border-gray-300");
        } else if (b !== btn){
            b.classList.add("bg-gray-100","text-gray-400","border-gray-200");
            b.classList.remove("bg-white","text-gray-700");
        }
    });

    if (!correct){
        btn.classList.add("bg-wrong","text-white","border-wrong","shadow-md");
        btn.classList.remove("bg-white","text-gray-700","border-gray-300");
        if (!wrongQuizzes.some(wq=>wq.id === quiz.id)){
            // store a shallow canonical copy
            wrongQuizzes.push({
                id: quiz.id,
                question: quiz.question,
                article: quiz.article,
                options: quiz.options,
                answer: quiz.answer,
                explanation: quiz.explanation,
                timer_sec: quiz.timer_sec,
                selectedAnswer: quiz.selectedAnswer
            });
            saveWrongQuizzes();
        } else {
            // update selectedAnswer for existing wrong
            const idx = wrongQuizzes.findIndex(w=>w.id===quiz.id);
            if (idx>=0){ wrongQuizzes[idx].selectedAnswer = quiz.selectedAnswer; saveWrongQuizzes(); }
        }
    } else {
        correctCount++;
    }

    explanationAreaEl.textContent = quiz.explanation || "";
    explanationAreaEl.classList.remove("hidden");
    nextButtonEl.disabled = false;
    nextButtonEl.classList.remove("opacity-50","cursor-not-allowed");
    nextButtonEl.classList.add("hover:bg-primary-dark");
    updateWrongCount();
}

// ----- updateWrongCount -----
function updateWrongCount(){ wrongCountEl.textContent = `ì˜¤ë‹µ: ${wrongQuizzes.length}`; }

// ----- next button handler: ìë™ ìƒˆ ì„¸íŠ¸ ë¡œë“œ ì²˜ë¦¬ -----
// Replace previous simple handler with this robust flow:
nextButtonEl.addEventListener("click", async ()=>{
    currentQuizIndex++;
    if (currentQuizIndex < allQuizzes.length){
        showQuiz();
        return;
    }
    // ì„¸íŠ¸ ì™„ë£Œ: ìë™ ìƒˆ ì„¸íŠ¸ ì‹œë„
    try{
        // UI: show completion summary first
        const total = allQuizzes.length;
        explanationAreaEl.textContent = `ì„¸íŠ¸ ì™„ë£Œ! ${total}ë¬¸ì œ ì¤‘ ${correctCount}ë¬¸ì œë¥¼ ë§í˜”ìŠµë‹ˆë‹¤. ìƒˆ ì„¸íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤...`;
        explanationAreaEl.classList.remove("hidden");
        // attempt to fetch new set (force refresh to avoid stale cache)
        await fetchNewSet({ force:true });
        // reset correctCount after new set is loaded
        correctCount = 0;
        // showQuiz() already called by fetchNewSet
    }catch(e){
        console.error("ìƒˆ ì„¸íŠ¸ ë¡œë“œ ì‹¤íŒ¨:", e);
        explanationAreaEl.textContent = `ìƒˆ ì„¸íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ${e.message || e}. ë¡œì»¬ ìºì‹œë‚˜ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.`;
    }
});

// ----- ë³µìŠµ ëª¨ë‹¬ -----
// build review list from wrongQuizzes (already normalized)
reviewButtonEl.addEventListener("click", ()=>{
    reviewListEl.innerHTML = "";
    if (!wrongQuizzes || wrongQuizzes.length === 0){
        reviewListEl.innerHTML = `<p class="text-center text-gray-500 py-4">ì•„ì§ í‹€ë¦° ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
        showModal();
        return;
    }
    wrongQuizzes.forEach((q, i) => {
        const div = document.createElement("div");
        div.className = "review-item p-4 border border-gray-200 rounded-lg bg-gray-50 hover:bg-gray-100 transition duration-150 cursor-pointer shadow-sm";
        div.innerHTML = `
            <p class="text-sm font-light text-gray-500 mb-1">ë³µìŠµ #${i+1}</p>
            <p class="font-bold text-gray-800 mb-2"><span class="text-primary">(${q.article?.lawName || 'ë²•ë¥  ìƒì‹'})</span> ${q.question}</p>
            <p class="text-sm"><span class="font-semibold text-wrong">ë‚´ ì„ íƒ:</span> ${q.selectedAnswer || "(ì„ íƒ ì—†ìŒ)"}</p>
            <p class="text-sm"><span class="font-semibold text-correct">ì •ë‹µ:</span> ${q.answer}</p>
            <div class="mt-3 p-2 text-xs bg-blue-100 border-l-2 border-primary rounded text-gray-700"><span class="font-bold">í•´ì„¤:</span> ${q.explanation}</div>
        `;
        div.addEventListener("click", ()=>{
            const idx = allQuizzes.findIndex(a => a.id === q.id);
            if (idx >= 0){
                currentQuizIndex = idx;
                showQuiz();
            } else {
                // if original not found, push the wrong quiz as a transient quiz and show
                allQuizzes.splice(currentQuizIndex+1, 0, q);
                currentQuizIndex = currentQuizIndex+1;
                showQuiz();
            }
            hideModal();
        });
        reviewListEl.appendChild(div);
    });
    showModal();
});
reviewCloseEl.addEventListener("click", ()=> hideModal());
reviewModalEl.addEventListener("click", e => { if (e.target === reviewModalEl) hideModal(); });

// ----- íƒ€ì´ë¨¸ -----
function startTimer(sec){
    timerEl.textContent = sec;
    clearInterval(timerInterval);
    timerInterval = setInterval(()=>{
        sec--;
        if (sec < 0){
            clearInterval(timerInterval);
            // mark as timeout if user hasn't already answered
            const firstOpt = optionsContainerEl.children[0];
            if (firstOpt && !firstOpt.disabled){
                const quiz = allQuizzes[currentQuizIndex];
                if (!wrongQuizzes.some(q=>q.id === quiz.id)){
                    wrongQuizzes.push({
                        id: quiz.id,
                        question: quiz.question,
                        article: quiz.article,
                        options: quiz.options,
                        answer: quiz.answer,
                        explanation: quiz.explanation,
                        timer_sec: quiz.timer_sec,
                        selectedAnswer: "(ì‹œê°„ ì´ˆê³¼)"
                    });
                    saveWrongQuizzes();
                }
                Array.from(optionsContainerEl.children).forEach(b=>{
                    b.disabled = true;
                    b.classList.add("cursor-default");
                    b.classList.remove("hover:bg-gray-50");
                    if (b.dataset.isCorrect === "true"){
                        b.classList.add("bg-correct","text-white","border-correct","shadow-md");
                        b.classList.remove("bg-white","text-gray-700","border-gray-300");
                    } else {
                        b.classList.add("bg-gray-100","text-gray-400","border-gray-200");
                        b.classList.remove("bg-white","text-gray-700");
                    }
                });
                explanationAreaEl.textContent = `ì‹œê°„ ì´ˆê³¼! ì •ë‹µ: ${quiz.answer} â€” í•´ì„¤: ${quiz.explanation}`;
                explanationAreaEl.classList.remove("hidden");
                explanationAreaEl.classList.add("bg-red-100","border-wrong");
                nextButtonEl.disabled = false;
                nextButtonEl.classList.remove("opacity-50","cursor-not-allowed");
                updateWrongCount();
            }
            return;
        }
        timerEl.textContent = sec;
        if (sec <= 5) timerEl.classList.add("text-wrong"); else timerEl.classList.remove("text-wrong");
    }, 1000);
}

// ----- ì´ˆê¸° ì‹¤í–‰ -----
window.onload = () => {
    loadWrongQuizzes();
    loadQuizzes();
};

</script>
</body>
</html>
