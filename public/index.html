<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’¡ ë²•ë¥  ìƒì‹ í€´ì¦ˆ ğŸ’¡</title>
    
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d; 
            --success-color: #28a745; 
            --danger-color: #dc3545; 
            --warning-color: #ffc107; 
            --font-color: #343a40;
            --background-color: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--font-color);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #quiz-container, #result-screen, #review-screen {
            width: 100%;
            max-width: 800px;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
            margin-bottom: 20px;
        }
        
        #result-screen, #review-screen {
            display: none;
            text-align: center;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 30px;
        }

        #quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }
        
        #timer {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--danger-color);
            padding: 5px 15px;
            border: 2px solid var(--danger-color);
            border-radius: 8px;
        }

        #question-text {
            font-size: 1.3em;
            font-weight: 500;
            margin-bottom: 20px;
            background-color: #f1f3f5;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid var(--primary-color);
        }

        .option-button {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            text-align: left;
            border: 1px solid var(--secondary-color);
            border-radius: 8px;
            background-color: white;
            color: var(--font-color);
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, transform 0.1s;
        }

        .option-button:hover:not([disabled]) {
            background-color: #e9ecef;
            border-color: var(--primary-color);
        }
        
        /* --- í”¼ë“œë°± ë° í•´ì„¤ --- */
        .correct {
            background-color: #d4edda !important;
            border-color: var(--success-color) !important;
            color: var(--success-color) !important;
            font-weight: bold;
        }

        .incorrect {
            background-color: #f8d7da !important;
            border-color: var(--danger-color) !important;
            color: var(--danger-color) !important;
            font-weight: bold;
        }
        
        #explanation-area {
            border-top: 2px dashed var(--secondary-color);
            padding-top: 20px;
            margin-top: 25px;
        }

        #feedback-message {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        
        .feedback-correct { background-color: #d4edda; color: var(--success-color); }
        .feedback-incorrect { background-color: #f8d7da; color: var(--danger-color); }


        #explanation-content {
            white-space: pre-wrap;
            background-color: #fff3cd; 
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--warning-color);
            color: #856404;
        }

        /* --- ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ --- */
        #next-button, #review-button, #restart-button, .back-button {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 20px;
            box-sizing: border-box;
        }
        
        #review-button {
            background-color: var(--success-color);
        }

        /* --- ë³µìŠµ ëª¨ë“œ (ë¦¬ìŠ¤íŠ¸í˜•) ìŠ¤íƒ€ì¼ --- */
        .review-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #f8f9fa;
            text-align: left;
        }
        
        .review-item h3 {
            color: var(--primary-color);
            border-bottom: 2px dashed var(--secondary-color);
            padding-bottom: 10px;
            margin-top: 0;
        }
        
        .review-info.user-answer { background-color: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .review-info.correct-answer { background-color: #d4edda; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .review-info.explanation { background-color: #e6f7ff; padding: 15px; margin-top: 15px; border-left: 4px solid var(--primary-color); }

        .review-info strong { font-weight: bold; margin-right: 5px; }
    </style>
    
</head>
<body>

    <div id="quiz-container">
        <h1>ğŸ’¡ ë²•ë¥  ìƒì‹ í€´ì¦ˆ</h1>
        
        <div id="quiz-header">
            <div id="quiz-status">
                ë¬¸ì œ: <span id="current-quiz-index">0</span> / <span id="total-quiz-count">0</span>
                | ì •ë‹µ: <span id="correct-count">0</span>
            </div>
            <div id="timer">15s</div>
        </div>
        
        <div id="question-area">
            <div id="question-text">í€´ì¦ˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            <div id="options-container">
                </div>
        </div>

        <div id="explanation-area" style="display: none;">
            <div id="feedback-message"></div>
            <h3>ğŸ” ìì„¸í•œ í•´ì„¤ (ë³µìŠµ ëª¨ë“œ)</h3>
            <p id="explanation-content"></p>
        </div>

        <button id="next-button" style="display: none;">ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™</button>
    </div>

    <div id="result-screen">
        <h2>ğŸ‰ í€´ì¦ˆ ì™„ë£Œ!</h2>
        <p>ì´ ì •ë‹µ ìˆ˜: <span id="final-correct-count"></span> / <span id="final-total-count"></span></p>
        <p>ì ìˆ˜: <span id="final-score"></span>ì </p>
        
        <button id="review-button">ğŸ“š ë³µìŠµ ë…¸íŠ¸ ë³´ê¸°</button>
        <button id="restart-button" class="back-button" onclick="resetQuiz()">ë‹¤ì‹œ ì‹œì‘ (ìƒˆ í€´ì¦ˆ)</button>
    </div>

    <div id="review-screen">
        <h1>ğŸ“š ë³µìŠµ ë…¸íŠ¸</h1>
        <div id="review-list">
            </div>
        <button class="back-button" onclick="showResultsScreen()">ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>

    <script>
       // ========================
    // --- ìƒìˆ˜ & ì „ì—­ ë³€ìˆ˜ ---
    // ========================
    const QUIZ_API_URL = "/api/quizzes";
    const STORAGE_KEY_QUIZZES = "law_quizzes_data";
    const STORAGE_KEY_PROGRESS = "law_quizzes_progress";
    
    let allQuizzes = [];
    let currentQuizIndex = 0;
    let correctCount = 0;
    let isAnswered = false;
    
    // DOM ìš”ì†Œ
    const quizContainerEl = document.getElementById("quiz-container");
    const questionTextEl = document.getElementById("question-text");
    const optionsContainerEl = document.getElementById("options-container");
    const currentQuizIndexEl = document.getElementById("current-quiz-index");
    const totalQuizCountEl = document.getElementById("total-quiz-count");
    const correctCountEl = document.getElementById("correct-count");
    const nextButtonEl = document.getElementById("next-button");
    const timerEl = document.getElementById("timer");
    const resultScreenEl = document.getElementById("result-screen");
    const reviewScreenEl = document.getElementById("review-screen");
    const explanationAreaEl = document.getElementById("explanation-area");
    
    // ========================
    // --- ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì²˜ë¦¬ ---
    // ========================
    function loadQuizzesFromLocalStorage() {
        const data = localStorage.getItem(STORAGE_KEY_QUIZZES);
        return data ? JSON.parse(data) : null;
    }
    
    function saveQuizzesToLocalStorage() {
        localStorage.setItem(STORAGE_KEY_QUIZZES, JSON.stringify(allQuizzes));
    }
    
    function loadProgressFromLocalStorage() {
        const data = localStorage.getItem(STORAGE_KEY_PROGRESS);
        return data ? JSON.parse(data) : null;
    }
    
    function saveProgressToLocalStorage() {
        localStorage.setItem(STORAGE_KEY_PROGRESS, JSON.stringify({
            index: currentQuizIndex,
            correct: correctCount,
            total: allQuizzes.length
        }));
    }
    
    // ========================
    // --- í€´ì¦ˆ ì´ˆê¸°í™” & ë¡œë“œ ---
    // ========================
    async function loadQuizzes(force_reload = false) { 
        const cachedData = loadQuizzesFromLocalStorage();
        const cachedProgress = loadProgressFromLocalStorage();
    
        if (cachedData && cachedProgress && cachedData.length === cachedProgress.total && !force_reload) {
            allQuizzes = cachedData;
            currentQuizIndex = cachedProgress.index;
            correctCount = cachedProgress.correct;
            console.log(`âœ… ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í€´ì¦ˆ ë¡œë“œ. í˜„ì¬ ${currentQuizIndex + 1}ë²ˆì§¸ ë¬¸ì œë¶€í„° ì‹œì‘.`);
        } else {
            if (force_reload) {
                console.log("ğŸ”„ ìƒˆ í€´ì¦ˆ ì„¸íŠ¸ë¥¼ APIì—ì„œ ë¡œë“œí•©ë‹ˆë‹¤.");
                localStorage.removeItem(STORAGE_KEY_PROGRESS);
                localStorage.removeItem(STORAGE_KEY_QUIZZES);
            } else {
                console.log("ğŸš€ ì´ˆê¸° ë¡œë“œ: ë¡œì»¬ ë°ì´í„°ê°€ ì—†ìœ¼ë¯€ë¡œ ìƒˆ í€´ì¦ˆ ì„¸íŠ¸ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.");
            }
    
            questionTextEl.textContent = "ğŸš€ í€´ì¦ˆ ì„œë²„ì—ì„œ ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
            try {
                const response = await fetch(QUIZ_API_URL, { cache: "no-store" });
                if (!response.ok) throw new Error(`HTTP ì˜¤ë¥˜! ìƒíƒœ: ${response.status}`);
    
                allQuizzes = await response.json();
                if (allQuizzes.length === 0) throw new Error("ì„œë²„ì—ì„œ ìœ íš¨í•œ í€´ì¦ˆ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
    
                currentQuizIndex = 0;
                correctCount = 0;
    
                saveQuizzesToLocalStorage();
                saveProgressToLocalStorage();
                console.log("âœ… APIì—ì„œ ìƒˆ í€´ì¦ˆ ë¡œë“œ ë° ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ ì™„ë£Œ.");
            } catch (error) {
                console.error("í€´ì¦ˆ ë¡œë“œ ì‹¤íŒ¨:", error);
                questionTextEl.textContent = `âŒ í€´ì¦ˆ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;
                timerEl.textContent = "ì˜¤ë¥˜";
                return;
            }
        }
    
        totalQuizCountEl.textContent = allQuizzes.length;
        correctCountEl.textContent = correctCount;
    
        // ì²« ë¬¸ì œ í‘œì‹œ
        if (allQuizzes.length > 0 && currentQuizIndex < allQuizzes.length) {
            showQuiz();
        } else {
            console.warn("âš ï¸ ë¡œë“œëœ í€´ì¦ˆê°€ ì—†ê±°ë‚˜ í˜„ì¬ ì¸ë±ìŠ¤ê°€ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¨.");
        }
    }
    
    // ========================
    // --- í€´ì¦ˆ í‘œì‹œ ---
    // ========================
    function showQuiz() {
        if (currentQuizIndex >= allQuizzes.length) {
            showResults();
            return;
        }
    
        const quiz = allQuizzes[currentQuizIndex];
        console.log("ğŸ“Œ í˜„ì¬ ë¬¸ì œ:", quiz);
    
        quizContainerEl.style.display = 'block';
        resultScreenEl.style.display = 'none';
        reviewScreenEl.style.display = 'none';
        isAnswered = false;
        nextButtonEl.style.display = 'none';
        explanationAreaEl.style.display = 'none';
    
        currentQuizIndexEl.textContent = currentQuizIndex + 1;
        const lawName = quiz.source_law_name || "ë²•ë¥  ìƒì‹";
        questionTextEl.innerHTML = `<span style="color: var(--secondary-color);">(${lawName})</span> ${quiz.question}`;
        
        optionsContainerEl.innerHTML = '';
        quiz.options.forEach((option, index) => {
            const button = document.createElement('button');
            button.className = 'option-button';
            button.textContent = `${index + 1}. ${option.text}`;
            button.dataset.isCorrect = option.is_correct;
            button.addEventListener('click', () => checkAnswer(button, quiz));
            optionsContainerEl.appendChild(button);
        });
    
        nextButtonEl.textContent = (currentQuizIndex < allQuizzes.length - 1) ? "ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™" : "ê²°ê³¼ ë³´ê¸°";
        startTimer(quiz.timer_sec || 15);
    }
    
    // ========================
    // --- ë‹¤ìŒ ë¬¸ì œ / ë‹µ ì²´í¬ ---
    // ========================
    nextButtonEl.addEventListener('click', () => {
        if (!isAnswered) return;
        currentQuizIndex++;
        saveProgressToLocalStorage();
        showQuiz();
    });
    
    function checkAnswer(button, quiz) {
        if (isAnswered) return;
        isAnswered = true;
    
        const isCorrect = button.dataset.isCorrect === "true";
        if (isCorrect) correctCount++;
        saveProgressToLocalStorage();
        correctCountEl.textContent = correctCount;
    
        explanationAreaEl.textContent = quiz.explanation || "í•´ì„¤ì´ ì—†ìŠµë‹ˆë‹¤.";
        explanationAreaEl.style.display = 'block';
        nextButtonEl.style.display = 'inline-block';
    }
    
    // ========================
    // --- ê²°ê³¼ í™”ë©´ ---
    // ========================
    function showResults() {
        quizContainerEl.style.display = 'none';
        resultScreenEl.style.display = 'block';
        resultScreenEl.innerHTML = `<h2>í€´ì¦ˆ ì™„ë£Œ!</h2><p>ì •ë‹µ ê°œìˆ˜: ${correctCount} / ${allQuizzes.length}</p>`;
    }
    
    // ========================
    // --- íƒ€ì´ë¨¸ ---
    // ========================
    let timerInterval;
    function startTimer(seconds) {
        clearInterval(timerInterval);
        let remaining = seconds;
        timerEl.textContent = remaining;
    
        timerInterval = setInterval(() => {
            remaining--;
            timerEl.textContent = remaining;
            if (remaining <= 0) {
                clearInterval(timerInterval);
                nextButtonEl.style.display = 'inline-block';
            }
        }, 1000);
    }
    
    // ========================
    // --- í€´ì¦ˆ ì¬ì‹œì‘ ---
    // ========================
    function resetQuiz() {
        localStorage.removeItem(STORAGE_KEY_PROGRESS);
        localStorage.removeItem(STORAGE_KEY_QUIZZES);
        currentQuizIndex = 0;
        correctCount = 0;
    
        loadQuizzes(true).catch(error => {
            console.error("í€´ì¦ˆ ì¬ì‹œì‘ ì‹¤íŒ¨:", error);
            alert("í€´ì¦ˆ ì¬ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
        });
    }
    
    // ========================
    // --- ì´ˆê¸° ë¡œë“œ ---
    // ========================
    loadQuizzes();
    </script>
</body>
</html>
