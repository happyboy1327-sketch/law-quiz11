<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>법률 퀴즈</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family:'Inter','Noto Sans KR',Arial,sans-serif; margin:0; padding:0; }
.modal-overlay { background-color: rgba(0,0,0,0.5); transition: opacity 0.3s ease-in-out; }
</style>
<script>
tailwind.config = {
    theme: {
        extend: {
            colors: {
                'primary':'#1976d2',
                'primary-dark':'#1565c0',
                'correct':'#4caf50',
                'wrong':'#f44336',
                'bg-light':'#f0f2f5'
            }
        }
    }
};
</script>
</head>
<body class="bg-bg-light min-h-screen p-4 flex justify-center items-start">

<div id="quiz-container" class="max-w-xl w-full mx-auto mt-5 p-6 md:p-8 bg-white rounded-xl shadow-2xl relative border border-gray-100">
    <div class="flex justify-between items-center mb-4 relative h-10">
        <button id="review-button" class="px-3 py-1 text-sm font-semibold text-white bg-primary hover:bg-primary-dark rounded-lg transition duration-200 shadow-md">
            오답 복습
        </button>
        <div class="flex flex-col items-end space-y-1">
            <div id="timer" class="text-xl font-bold text-gray-700">0</div>
            <div id="wrong-count" class="text-sm font-semibold text-wrong">오답: 0</div>
        </div>
    </div>

    <div id="question-text" class="mt-8 mb-6 text-lg font-medium text-gray-800 leading-relaxed min-h-[4rem]">
        {질문이 여기에 표시됩니다.}
    </div>
    <div id="options-container" class="space-y-3"></div>
    <div id="explanation-area" class="mt-4 p-4 text-sm bg-blue-50 border-l-4 border-primary rounded-lg text-gray-700 hidden transition-all duration-300">
        해설이 여기에 표시됩니다.
    </div>
    <button id="next-button" class="w-full mt-6 py-3 border-none rounded-lg bg-primary text-white text-base font-semibold cursor-pointer hover:bg-primary-dark transition duration-200 shadow-lg hover:shadow-xl">
        다음 문제
    </button>
</div>

<div id="review-modal" class="fixed inset-0 flex items-center justify-center modal-overlay opacity-0 pointer-events-none z-50 transition duration-300">
    <div class="bg-white rounded-xl w-11/12 max-w-2xl max-h-[80vh] overflow-y-auto p-6 shadow-2xl transform scale-95 transition-transform duration-300">
        <h2 class="text-xl font-bold mb-4 border-b pb-2 text-gray-800">오답 복습 목록</h2>
        <div id="review-list" class="space-y-3"></div>
        <button id="review-close" class="mt-6 w-full py-2 bg-wrong text-white font-semibold rounded-lg hover:bg-red-700 transition duration-200 shadow-md">
            닫기
        </button>
    </div>
</div>

<script type="module">
// ----------------------- 설정 -----------------------
import { generateAndCacheQuizzes } from './quiz_generator.js';

const QUIZ_API_URL = "/api/quizzes"; // 서버에서 cached_law_quizzes.json 제공
let allQuizzes=[], currentQuizIndex=0, correctCount=0, wrongQuizzes=[];

const questionTextEl=document.getElementById("question-text");
const optionsContainerEl=document.getElementById("options-container");
const explanationAreaEl=document.getElementById("explanation-area");
const nextButtonEl=document.getElementById("next-button");
const reviewButtonEl=document.getElementById("review-button");
const reviewModalEl=document.getElementById("review-modal");
const reviewListEl=document.getElementById("review-list");
const reviewCloseEl=document.getElementById("review-close");
const timerEl=document.getElementById("timer");
const wrongCountEl=document.getElementById("wrong-count");
let timerInterval;

// ----------------------- 모달 제어 -----------------------
function showModal(){ reviewModalEl.classList.remove('opacity-0','pointer-events-none'); reviewModalEl.children[0].classList.remove('scale-95'); reviewModalEl.children[0].classList.add('scale-100'); }
function hideModal(){ reviewModalEl.classList.add('opacity-0','pointer-events-none'); reviewModalEl.children[0].classList.remove('scale-100'); reviewModalEl.children[0].classList.add('scale-95'); }
reviewCloseEl.addEventListener("click",hideModal);
reviewModalEl.addEventListener("click",(e)=>{ if(e.target===reviewModalEl) hideModal(); });

// ----------------------- 로컬 스토리지 -----------------------
const STORAGE_KEY_QUIZZES = "law_quizzes_data";
const STORAGE_KEY_PROGRESS = "law_quizzes_progress";
const STORAGE_KEY_WRONG = "law_quizzes_wrong";

function loadFromLocalStorage(){ 
    allQuizzes=JSON.parse(localStorage.getItem(STORAGE_KEY_QUIZZES)||"[]"); 
    wrongQuizzes=JSON.parse(localStorage.getItem(STORAGE_KEY_WRONG)||"[]"); 
    const prog=JSON.parse(localStorage.getItem(STORAGE_KEY_PROGRESS)||'{"index":0,"correct":0}'); 
    currentQuizIndex=prog.index||0; 
    correctCount=prog.correct||0;
}
function saveProgress(){ localStorage.setItem(STORAGE_KEY_PROGRESS, JSON.stringify({index:currentQuizIndex,correct:correctCount})); }
function saveQuizzes(){ localStorage.setItem(STORAGE_KEY_QUIZZES, JSON.stringify(allQuizzes)); localStorage.setItem(STORAGE_KEY_WRONG, JSON.stringify(wrongQuizzes)); }

// ----------------------- 퀴즈 로드 -----------------------
async function loadQuizzes(force_reload=false){
    if(!force_reload){
        loadFromLocalStorage();
        if(allQuizzes.length>0){ showQuiz(); updateWrongCount(); return; }
    }
    // 실제 API fetch
    try{
        const res = await fetch(QUIZ_API_URL);
        const data = await res.json();
        allQuizzes=data;
        currentQuizIndex=0;
        correctCount=0;
        saveQuizzes();
        saveProgress();
        showQuiz();
    }catch(e){
        console.error("퀴즈 API 로드 실패:", e);
        questionTextEl.textContent="퀴즈 로드 실패. 서버 상태 확인 필요.";
    }
}

// ----------------------- 퀴즈 표시 -----------------------
function showQuiz(){
    clearInterval(timerInterval);
    const quiz = allQuizzes[currentQuizIndex];
    if(!quiz){ console.warn("퀴즈 없음"); return; }

    questionTextEl.innerHTML=`<span class="text-sm font-light text-gray-500 mr-2">[${currentQuizIndex+1}/${allQuizzes.length}]</span>
                               <span class="text-primary font-bold mr-2">(${quiz.source_law_name||'법률 상식'})</span>
                               ${quiz.question}`;
    optionsContainerEl.innerHTML="";
    explanationAreaEl.classList.add("hidden"); explanationAreaEl.textContent="";
    nextButtonEl.disabled=true; nextButtonEl.classList.add("opacity-50","cursor-not-allowed"); nextButtonEl.classList.remove("hover:bg-primary-dark");

    quiz.options.forEach((opt,i)=>{
        const btn=document.createElement("button");
        btn.className=`w-full text-left p-4 border border-gray-300 rounded-xl cursor-pointer bg-white hover:bg-gray-50 transition duration-150 shadow-sm text-gray-700 font-medium`;
        btn.textContent=`${i+1}. ${opt.text}`;
        btn.dataset.isCorrect=opt.is_correct;
        btn.addEventListener("click",()=>checkAnswer(btn,quiz));
        optionsContainerEl.appendChild(btn);
    });
    startTimer(quiz.timer_sec);
}

// ----------------------- 정답/오답 처리 -----------------------
function checkAnswer(btn, quiz){
    clearInterval(timerInterval);
    const correct = btn.dataset.isCorrect==="true";
    quiz.selectedAnswer = btn.textContent.replace(/^\d+\.\s*/,"");

    Array.from(optionsContainerEl.children).forEach(b=>{
        b.disabled=true; b.classList.add("cursor-default"); b.classList.remove("hover:bg-gray-50");
        if(b.dataset.isCorrect==="true"){ b.classList.add("bg-correct","text-white","border-correct","shadow-md"); b.classList.remove("bg-white","text-gray-700","border-gray-300"); }
        else if(b!==btn){ b.classList.add("bg-gray-100","text-gray-400","border-gray-200"); b.classList.remove("bg-white","text-gray-700"); }
    });

    if(!correct){ btn.classList.add("bg-wrong","text-white","border-wrong","shadow-md"); btn.classList.remove("bg-white","text-gray-700","border-gray-300");
        if(!wrongQuizzes.some(q=>q.id===quiz.id)) wrongQuizzes.push(quiz);
    } else correctCount++;

    explanationAreaEl.textContent=quiz.explanation;
    explanationAreaEl.classList.remove("hidden");
    nextButtonEl.disabled=false; nextButtonEl.classList.remove("opacity-50","cursor-not-allowed"); nextButtonEl.classList.add("hover:bg-primary-dark");
    updateWrongCount(); saveQuizzes(); saveProgress();
}

// ----------------------- 오답 누적 표시 -----------------------
function updateWrongCount(){ wrongCountEl.textContent=`오답: ${wrongQuizzes.length}`; }

// ----------------------- 다음 문제 -----------------------
nextButtonEl.addEventListener("click",()=>{
    currentQuizIndex++;
    if(currentQuizIndex<allQuizzes.length) showQuiz();
    else {
        explanationAreaEl.textContent=`퀴즈 완료! 총 ${allQuizzes.length}문제 중 ${correctCount}문제 맞음. 오답: ${wrongQuizzes.length}개.`;
        explanationAreaEl.classList.remove("hidden"); explanationAreaEl.classList.add("bg-yellow-100","border-yellow-500","text-center","font-bold","text-lg");
        nextButtonEl.classList.add("hidden");
    }
    saveProgress();
});

// ----------------------- 오답 복습 모달 -----------------------
reviewButtonEl.addEventListener("click",()=>{
    reviewListEl.innerHTML="";
    if(wrongQuizzes.length===0){ reviewListEl.innerHTML='<p class="text-center text-gray-500 py-4">아직 틀린 문제가 없습니다!</p>'; showModal(); return; }

    wrongQuizzes.forEach((q,i)=>{
        const div=document.createElement("div");
        div.className="review-item p-4 border border-gray-200 rounded-lg bg-gray-50 hover:bg-gray-100 transition duration-150 cursor-pointer shadow-sm";
        div.innerHTML=`
            <p class="text-sm font-light text-gray-500 mb-1">복습 #${i+1}</p>
            <p class="font-bold text-gray-800 mb-2"><span class="text-primary">(${q.source_law_name})</span> ${q.question}</p>
            <p class="text-sm"><span class="font-semibold text-wrong">내 선택:</span> ${q.selectedAnswer||"(선택 없음)"}</p>
            <p class="text-sm"><span class="font-semibold text-correct">정답:</span> ${q.answer}</p>
            <div class="mt-3 p-2 text-xs bg-blue-100 border-l-2 border-primary rounded text-gray-700"><span class="font-bold">해설:</span> ${q.explanation}</div>
        `;
        div.addEventListener("click",()=>{ currentQuizIndex=allQuizzes.findIndex(item=>item.id===q.id); showQuiz(); hideModal(); });
        reviewListEl.appendChild(div);
    });
    showModal();
});

// ----------------------- 타이머 -----------------------
function startTimer(sec){
    timerEl.textContent=sec; clearInterval(timerInterval);
    timerInterval=setInterval(()=>{
        sec--;
        if(sec<0){
            clearInterval(timerInterval);
            const quiz=allQuizzes[currentQuizIndex];
            if(!wrongQuizzes.some(q=>q.id===quiz.id)) wrongQuizzes.push(quiz);
            Array.from(optionsContainerEl.children).forEach(b=>{
                b.disabled=true; b.classList.add("cursor-default"); b.classList.remove("hover:bg-gray-50");
                if(b.dataset.isCorrect==="true"){ b.classList.add("bg-correct","text-white","border-correct","shadow-md"); b.classList.remove("bg-white","text-gray-700","border-gray-300"); }
                else b.classList.add("bg-gray-100","text-gray-400","border-gray-200"); b.classList.remove("bg-white","text-gray-700");
            });
            quiz.selectedAnswer="(시간 초과)";
            explanationAreaEl.textContent=`시간 초과! 정답: ${quiz.answer}. 해설: ${quiz.explanation}`;
            explanationAreaEl.classList.remove("hidden"); explanationAreaEl.classList.add("bg-red-100","border-wrong");
            nextButtonEl.disabled=false; nextButtonEl.classList.remove("opacity-50","cursor-not-allowed","hidden"); nextButtonEl.classList.add("hover:bg-primary-dark");
            updateWrongCount(); saveQuizzes(); saveProgress();
            return;
        }
        timerEl.textContent=sec;
        if(sec<=5) timerEl.classList.add("text-wrong"); else timerEl.classList.remove("text-wrong");
    },1000);
}

window.onload=()=>loadQuizzes();
</script>
</body>
</html>
