<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’¡ ë²•ë¥  ìƒì‹ í€´ì¦ˆ ğŸ’¡</title>
    
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d; 
            --success-color: #28a745; 
            --danger-color: #dc3545; 
            --warning-color: #ffc107; 
            --font-color: #343a40;
            --background-color: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--font-color);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #quiz-container, #result-screen, #review-screen {
            width: 100%;
            max-width: 800px;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
            margin-bottom: 20px;
        }
        
        #result-screen, #review-screen {
            display: none;
            text-align: center;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 30px;
        }

        #quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }
        
        #timer {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--danger-color);
            padding: 5px 15px;
            border: 2px solid var(--danger-color);
            border-radius: 8px;
        }

        #question-text {
            font-size: 1.3em;
            font-weight: 500;
            margin-bottom: 20px;
            background-color: #f1f3f5;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid var(--primary-color);
        }

        .option-button {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            text-align: left;
            border: 1px solid var(--secondary-color);
            border-radius: 8px;
            background-color: white;
            color: var(--font-color);
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, transform 0.1s;
        }

        .option-button:hover:not([disabled]) {
            background-color: #e9ecef;
            border-color: var(--primary-color);
        }
        
        /* --- í”¼ë“œë°± ë° í•´ì„¤ --- */
        .correct {
            background-color: #d4edda !important;
            border-color: var(--success-color) !important;
            color: var(--success-color) !important;
            font-weight: bold;
        }

        .incorrect {
            background-color: #f8d7da !important;
            border-color: var(--danger-color) !important;
            color: var(--danger-color) !important;
            font-weight: bold;
        }
        
        #explanation-area {
            border-top: 2px dashed var(--secondary-color);
            padding-top: 20px;
            margin-top: 25px;
        }

        #feedback-message {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        
        .feedback-correct { background-color: #d4edda; color: var(--success-color); }
        .feedback-incorrect { background-color: #f8d7da; color: var(--danger-color); }


        #explanation-content {
            white-space: pre-wrap;
            background-color: #fff3cd; 
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--warning-color);
            color: #856404;
        }

        /* --- ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ --- */
        #next-button, #review-button, #restart-button, .back-button {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 20px;
            box-sizing: border-box;
        }
        
        #review-button {
            background-color: var(--success-color);
        }

        /* --- ë³µìŠµ ëª¨ë“œ (ë¦¬ìŠ¤íŠ¸í˜•) ìŠ¤íƒ€ì¼ --- */
        .review-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #f8f9fa;
            text-align: left;
        }
        
        .review-item h3 {
            color: var(--primary-color);
            border-bottom: 2px dashed var(--secondary-color);
            padding-bottom: 10px;
            margin-top: 0;
        }
        
        .review-info.user-answer { background-color: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .review-info.correct-answer { background-color: #d4edda; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .review-info.explanation { background-color: #e6f7ff; padding: 15px; margin-top: 15px; border-left: 4px solid var(--primary-color); }

        .review-info strong { font-weight: bold; margin-right: 5px; }
    </style>
    
</head>
<body>

    <div id="quiz-container">
        <h1>ğŸ’¡ ë²•ë¥  ìƒì‹ í€´ì¦ˆ</h1>
        
        <div id="quiz-header">
            <div id="quiz-status">
                ë¬¸ì œ: <span id="current-quiz-index">0</span> / <span id="total-quiz-count">0</span>
                | ì •ë‹µ: <span id="correct-count">0</span>
            </div>
            <div id="timer">15s</div>
        </div>
        
        <div id="question-area">
            <div id="question-text">í€´ì¦ˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            <div id="options-container">
                </div>
        </div>

        <div id="explanation-area" style="display: none;">
            <div id="feedback-message"></div>
            <h3>ğŸ” ìì„¸í•œ í•´ì„¤ (ë³µìŠµ ëª¨ë“œ)</h3>
            <p id="explanation-content"></p>
        </div>

        <button id="next-button" style="display: none;">ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™</button>
    </div>

    <div id="result-screen">
        <h2>ğŸ‰ í€´ì¦ˆ ì™„ë£Œ!</h2>
        <p>ì´ ì •ë‹µ ìˆ˜: <span id="final-correct-count"></span> / <span id="final-total-count"></span></p>
        <p>ì ìˆ˜: <span id="final-score"></span>ì </p>
        
        <button id="review-button">ğŸ“š ë³µìŠµ ë…¸íŠ¸ ë³´ê¸°</button>
        <button id="restart-button" class="back-button" onclick="resetQuiz()">ë‹¤ì‹œ ì‹œì‘ (ìƒˆ í€´ì¦ˆ)</button>
    </div>

    <div id="review-screen">
        <h1>ğŸ“š ë³µìŠµ ë…¸íŠ¸</h1>
        <div id="review-list">
            </div>
        <button class="back-button" onclick="showResultsScreen()">ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>

    <script>
        // ìƒìˆ˜ ë° ë³€ìˆ˜ ì„¤ì •
        const QUIZ_API_URL = '/api/quizzes'; // ğŸ¯ Vercel ë°°í¬ë¥¼ ìœ„í•œ ìƒëŒ€ ê²½ë¡œ
        const STORAGE_KEY_QUIZZES = 'lawQuizzesData';   
        const STORAGE_KEY_PROGRESS = 'lawQuizProgress'; 
        
        let allQuizzes = [];
        let currentQuizIndex = 0;
        let correctCount = 0;
        let timerInterval;
        let isAnswered = false;
        
        // DOM ìš”ì†Œ ìºì‹±
        const questionTextEl = document.getElementById('question-text');
        const optionsContainerEl = document.getElementById('options-container');
        const nextButtonEl = document.getElementById('next-button');
        const timerEl = document.getElementById('timer');
        const currentQuizIndexEl = document.getElementById('current-quiz-index');
        const totalQuizCountEl = document.getElementById('total-quiz-count');
        const correctCountEl = document.getElementById('correct-count');
        const explanationAreaEl = document.getElementById('explanation-area');
        const explanationContentEl = document.getElementById('explanation-content');
        const feedbackMessageEl = document.getElementById('feedback-message');
        const resultScreenEl = document.getElementById('result-screen');
        const quizContainerEl = document.getElementById('quiz-container');
        const reviewScreenEl = document.getElementById('review-screen');
        const reviewListEl = document.getElementById('review-list');
        const reviewButtonEl = document.getElementById('review-button');

        // --- ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ê´€ë¦¬ í•¨ìˆ˜ ---

        function saveProgressToLocalStorage() {
            const progress = {
                index: currentQuizIndex,
                correct: correctCount,
                total: allQuizzes.length
            };
            localStorage.setItem(STORAGE_KEY_PROGRESS, JSON.stringify(progress));
        }

        function loadProgressFromLocalStorage() {
            const data = localStorage.getItem(STORAGE_KEY_PROGRESS);
            return data ? JSON.parse(data) : null;
        }
        
        function saveQuizzesToLocalStorage() {
            localStorage.setItem(STORAGE_KEY_QUIZZES, JSON.stringify(allQuizzes));
        }

        function loadQuizzesFromLocalStorage() {
            const data = localStorage.getItem(STORAGE_KEY_QUIZZES);
            return data ? JSON.parse(data) : null;
        }

        // --- 1. í€´ì¦ˆ ë°ì´í„° ë¡œë“œ ---
        async function loadQuizzes(force_reload = false) { 
            const cachedData = loadQuizzesFromLocalStorage();
            const cachedProgress = loadProgressFromLocalStorage();
            
            // 1. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ë°ì´í„°ê°€ ìˆê³ , ì§„í–‰ ìƒí™©ì´ ì €ì¥ë˜ì–´ ìˆìœ¼ë©´ ë¡œë“œ (force_reloadê°€ falseì¼ ë•Œë§Œ)
            if (cachedData && cachedProgress && cachedData.length === cachedProgress.total && !force_reload) {
                allQuizzes = cachedData;
                currentQuizIndex = cachedProgress.index;
                correctCount = cachedProgress.correct;
                console.log(`âœ… ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í€´ì¦ˆ ë¡œë“œ. í˜„ì¬ ${currentQuizIndex + 1}ë²ˆì§¸ ë¬¸ì œë¶€í„° ì‹œì‘.`);
                
            } else {
                // 2. ë°ì´í„°ê°€ ì—†ê±°ë‚˜ force_reloadê°€ trueì´ë©´ APIì—ì„œ ìƒˆë¡œ ë¡œë“œ
                if (force_reload) {
                    console.log("ğŸ”„ 'ë‹¤ì‹œ ì‹œì‘' ë²„íŠ¼ì— ì˜í•´ ìƒˆ í€´ì¦ˆ ì„¸íŠ¸ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.");
                    // ğŸ¯ ìƒˆ í€´ì¦ˆë¥¼ ë¡œë“œí•˜ë¯€ë¡œ, ì§„í–‰ ìƒí™©ê³¼ ê¸°ì¡´ í€´ì¦ˆ ë°ì´í„°ë¥¼ ì´ˆê¸°í™” (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë³´ì¡´ ìš”êµ¬ì‚¬í•­ ë°˜ì˜)
                    // ìƒˆ í€´ì¦ˆë¥¼ ê°€ì ¸ì˜¬ ë•ŒëŠ” ê¸°ì¡´ í€´ì¦ˆ ë°ì´í„°(STORAGE_KEY_QUIZZES)ë¥¼ ì§€ì›Œì•¼ ì˜¤ë‹µ ë…¸íŠ¸ì— ì¤‘ë³µë˜ê±°ë‚˜ ì¶©ëŒí•˜ì§€ ì•ŠìŒ
                    localStorage.removeItem(STORAGE_KEY_PROGRESS); 
                    localStorage.removeItem(STORAGE_KEY_QUIZZES); 
                } else {
                    console.log("ğŸš€ ì´ˆê¸° ë¡œë“œ: ë¡œì»¬ ë°ì´í„°ê°€ ì—†ìœ¼ë¯€ë¡œ ìƒˆ í€´ì¦ˆ ì„¸íŠ¸ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.");
                }
                
                questionTextEl.textContent = "ğŸš€ í€´ì¦ˆ ì„œë²„ì—ì„œ ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
                try {
                    const response = await fetch(QUIZ_API_URL);
                    if (!response.ok) throw new Error(`HTTP ì˜¤ë¥˜! ìƒíƒœ: ${response.status}`);
                    
                    allQuizzes = await response.json();
                    if (allQuizzes.length === 0) throw new Error("ì„œë²„ì—ì„œ ìœ íš¨í•œ í€´ì¦ˆ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                    
                    currentQuizIndex = 0;
                    correctCount = 0;
                    
                    saveQuizzesToLocalStorage(); 
                    saveProgressToLocalStorage();
                    console.log("âœ… APIì—ì„œ ìƒˆ í€´ì¦ˆ ë¡œë“œ ë° ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ ì™„ë£Œ.");
                    
                } catch (error) {
                    console.error("í€´ì¦ˆ ë¡œë“œ ì‹¤íŒ¨:", error);
                    questionTextEl.textContent = `âŒ í€´ì¦ˆ ë¡œë“œ ì‹¤íŒ¨: ${error.message}. Vercel í™˜ê²½ ë³€ìˆ˜(API í‚¤) ì„¤ì • ë˜ëŠ” ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.`;
                    timerEl.textContent = "ì˜¤ë¥˜";
                    return;
                }
            }
            
            totalQuizCountEl.textContent = allQuizzes.length;
            correctCountEl.textContent = correctCount;

            // í€´ì¦ˆê°€ ì™„ë£Œëœ ìƒíƒœë¼ë©´ ê²°ê³¼ í™”ë©´ì„ ë³´ì—¬ì¤Œ
            if (currentQuizIndex >= allQuizzes.length && !force_reload) {
                showResults();
            }
            // force_reload ì‹œì—ëŠ” resetQuiz()ì—ì„œ showQuiz()ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
        }

        // --- 2. í€´ì¦ˆ í‘œì‹œ ---
        function showQuiz() {
            quizContainerEl.style.display = 'block';
            resultScreenEl.style.display = 'none';
            reviewScreenEl.style.display = 'none';

            isAnswered = false;
            nextButtonEl.style.display = 'none';
            explanationAreaEl.style.display = 'none'; 
            
            const quiz = allQuizzes[currentQuizIndex];
            
            currentQuizIndexEl.textContent = currentQuizIndex + 1;
            questionTextEl.innerHTML = `<span style="color: var(--secondary-color);">(${quiz.source_law_name})</span> ${quiz.question}`;
            optionsContainerEl.innerHTML = '';
            
            quiz.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-button';
                button.textContent = `${index + 1}. ${option.text}`;
                button.dataset.isCorrect = option.is_correct;
                button.addEventListener('click', () => checkAnswer(button, quiz));
                optionsContainerEl.appendChild(button);
            });
            
            nextButtonEl.textContent = (currentQuizIndex < allQuizzes.length - 1) ? "ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™" : "ê²°ê³¼ ë³´ê¸°";
            startTimer(quiz.timer_sec || 15);
        }
        
        // --- 3. ì •ë‹µ í™•ì¸ ë° í”¼ë“œë°± (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì˜êµ¬ ì €ì¥) ---
        function checkAnswer(selectedButton, quiz) {
            if (isAnswered) return;
            isAnswered = true;
            clearInterval(timerInterval);
            
            const isTimeUp = !selectedButton;
            const isCorrect = isTimeUp ? false : selectedButton.dataset.isCorrect === 'true';
            
            quiz.is_correct_answered = isCorrect;
            quiz.user_answer_text = isTimeUp ? "ì‹œê°„ ì´ˆê³¼ (ë¯¸ì„ íƒ)" : selectedButton.textContent.substring(3).trim();
            saveQuizzesToLocalStorage(); 

            if (isCorrect) {
                correctCount++;
                feedbackMessageEl.textContent = "âœ… ì •ë‹µì…ë‹ˆë‹¤!";
                feedbackMessageEl.className = 'feedback-message feedback-correct';
            } else {
                feedbackMessageEl.textContent = isTimeUp ? "â° ì‹œê°„ ì´ˆê³¼ë¡œ ì˜¤ë‹µ ì²˜ë¦¬ë©ë‹ˆë‹¤." : "âŒ ì˜¤ë‹µì…ë‹ˆë‹¤.";
                feedbackMessageEl.className = 'feedback-message feedback-incorrect';
                if (selectedButton) {
                    selectedButton.classList.add('incorrect');
                }
            }

            document.querySelectorAll('.option-button').forEach(btn => {
                btn.disabled = true;
                if (btn.dataset.isCorrect === 'true') { btn.classList.add('correct'); }
            });

            correctCountEl.textContent = correctCount;
            explanationContentEl.textContent = quiz.explanation;
            explanationAreaEl.style.display = 'block';
            nextButtonEl.style.display = 'block';
            
            saveProgressToLocalStorage(); 
        }

        // --- 4. íƒ€ì´ë¨¸ ê¸°ëŠ¥ ---
        function startTimer(duration) {
            let timeRemaining = duration;
            timerEl.textContent = `${timeRemaining}s`;

            timerInterval = setInterval(() => {
                timeRemaining--;
                timerEl.textContent = `${timeRemaining}s`;

                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    timerEl.textContent = 'TIME UP!';
                    if (!isAnswered) {
                         checkAnswer(null, allQuizzes[currentQuizIndex]);
                    }
                }
            }, 1000);
        }

        // --- 5. ê²°ê³¼ í™”ë©´ í‘œì‹œ ---
        function showResults() {
            clearInterval(timerInterval); 
            
            if (currentQuizIndex < allQuizzes.length) {
                currentQuizIndex = allQuizzes.length;
                saveProgressToLocalStorage();
            }

            quizContainerEl.style.display = 'none';
            resultScreenEl.style.display = 'block';
            reviewScreenEl.style.display = 'none';

            const total = allQuizzes.length;
            const score = Math.round((correctCount / total) * 100);

            document.getElementById('final-correct-count').textContent = correctCount;
            document.getElementById('final-total-count').textContent = total;
            document.getElementById('final-score').textContent = score;
        }
        
        // --- 6. ë³µìŠµ ë…¸íŠ¸ í™”ë©´ í‘œì‹œ (ë¦¬ìŠ¤íŠ¸í˜•) ---
        function showReviewMode() {
            resultScreenEl.style.display = 'none';
            quizContainerEl.style.display = 'none';
            reviewScreenEl.style.display = 'block';

            reviewListEl.innerHTML = '';
            
            // ğŸ¯ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ëœ ìµœì¢… ë°ì´í„°ë¥¼ ë¡œë“œí•˜ì—¬ ë³µìŠµ ë…¸íŠ¸ë¥¼ ë§Œë“­ë‹ˆë‹¤.
            const reviewQuizzes = loadQuizzesFromLocalStorage() || allQuizzes; 
            
            const incorrectQuizzes = reviewQuizzes.filter(quiz => quiz.is_correct_answered === false);

            if (incorrectQuizzes.length === 0) {
                reviewListEl.innerHTML = '<p style="text-align: center; font-size: 1.2em; color: var(--success-color);">ğŸ‰ **ëª¨ë“  ë¬¸ì œì— ì •ë‹µì„ ë§íˆì…¨ìŠµë‹ˆë‹¤! ë³µìŠµí•  ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.**</p>';
                return;
            }

            incorrectQuizzes.forEach((quiz, index) => {
                const listItem = document.createElement('div');
                listItem.className = 'review-item';
                
                const correctAnswer = quiz.options.find(opt => opt.is_correct) || { text: 'ì •ë‹µ ì—†ìŒ' };
                const answerStatus = 'âŒ ì˜¤ë‹µ / ì‹œê°„ ì´ˆê³¼';
                const answerColor = 'var(--danger-color)';

                listItem.innerHTML = `
                    <h3>${index + 1}. ${quiz.question} <span style="font-size: 0.8em; color: var(--secondary-color);">(${quiz.source_law_name})</span></h3>
                    
                    <div class="review-info user-answer">
                        <strong>ë‚˜ì˜ ë‹µë³€:</strong> 
                        <span style="color: ${answerColor}; font-weight: bold;">${answerStatus}</span>
                        <p>${quiz.user_answer_text || 'ì„ íƒ ì—†ìŒ'}</p>
                    </div>
                    
                    <div class="review-info correct-answer">
                        <strong>ì •ë‹µ:</strong>
                        <p>${correctAnswer.text}</p>
                    </div>

                    <div class="review-info explanation">
                        <strong>ìì„¸í•œ í•´ì„¤:</strong>
                        <p>${quiz.explanation}</p>
                    </div>
                `;
                
                reviewListEl.appendChild(listItem);
            });
        }
        
        // --- ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸° ---
        function showResultsScreen() {
             showResults();
        }

        // --- í€´ì¦ˆ ì´ˆê¸°í™” (ìƒˆ í€´ì¦ˆ ë¡œë“œ) ---
        function resetQuiz() {
            // ğŸ¯ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë¥¼ ì§€ìš°ì§€ ì•Šê³ , loadQuizzesì— ê°•ì œ ë¡œë“œ í”Œë˜ê·¸(true)ë¥¼ ì „ë‹¬í•˜ì—¬ ìƒˆ í€´ì¦ˆë¥¼ APIì—ì„œ ë¡œë“œí•©ë‹ˆë‹¤.
            loadQuizzes(true).then(() => { 
                showQuiz(); // ìƒˆ í€´ì¦ˆë¥¼ ë¡œë“œí•œ í›„ ì²« ë²ˆì§¸ ë¬¸ì œ í‘œì‹œ
            }).catch(error => {
                console.error("í€´ì¦ˆ ì¬ì‹œì‘ ì‹¤íŒ¨:", error);
                alert("í€´ì¦ˆ ì¬ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
            });
        }


        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ---
        nextButtonEl.addEventListener('click', () => {
             if (currentQuizIndex < allQuizzes.length - 1) {
                currentQuizIndex++;
                saveProgressToLocalStorage(); 
                showQuiz();
            } else {
                showResults();
            }
        });

        reviewButtonEl.addEventListener('click', showReviewMode);

        // --- ì´ˆê¸° ì‹¤í–‰ ---
        document.addEventListener('DOMContentLoaded', () => loadQuizzes(false));
    </script>
</body>
</html>