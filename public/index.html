<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ë²•ë¥  ìƒì‹ í€´ì¦ˆ</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background:#f0f0f0; }
#quiz-container { position: relative; border: 1px solid #ccc; padding: 20px; border-radius: 8px; max-width: 700px; margin: auto; background:#fff; }
#review-button { position: absolute; top: 10px; left: 10px; padding:5px 10px; cursor:pointer; }
#timer { position: absolute; top: 10px; right: 10px; font-weight:bold; }
#wrong-count { position: absolute; top: 40px; left: 10px; font-weight:bold; color:red; }
.option-button { display: block; width: 100%; margin: 5px 0; padding: 8px; border-radius: 4px; cursor: pointer; border:1px solid #ccc; text-align:left; }
.option-button.correct { background-color: #4caf50; color:#fff; }
.option-button.wrong { background-color: #f44336; color:#fff; }
#explanation-area { margin-top: 10px; font-weight:bold; }
#next-button { margin-top: 10px; padding: 8px 12px; cursor: pointer; }
#review-modal { display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); width:80%; max-width:600px; background:white; border:1px solid #ccc; padding:20px; z-index:1000; max-height:80%; overflow-y:auto; border-radius:8px; }
#review-modal h3 { margin-top:0; }
.review-item { display:block; width:100%; margin:5px 0; padding:5px; text-align:left; cursor:pointer; border:1px solid #ddd; border-radius:4px; background:#f9f9f9; }
.review-item:hover { background:#eee; }
</style>
</head>
<body>

<div id="quiz-container">
    <button id="review-button">ì˜¤ë‹µ ë³µìŠµ</button>
    <span id="timer">0</span>
    <span id="wrong-count">ì˜¤ë‹µ: 0</span>
    <div id="question-text"></div>
    <div id="options-container"></div>
    <div id="explanation-area"></div>
    <button id="next-button">ë‹¤ìŒ ë¬¸ì œ</button>
</div>

<div id="result-screen" style="display:none;"></div>

<div id="review-modal">
    <h3>ì˜¤ë‹µ ë³µìŠµ</h3>
    <div id="review-list"></div>
    <button id="close-review">ë‹«ê¸°</button>
</div>

<script>
const QUIZ_API_URL = "/api/quizzes";
const STORAGE_KEY_QUIZZES = "law_quizzes_data";
const STORAGE_KEY_PROGRESS = "law_quizzes_progress";
const STORAGE_KEY_WRONG = "law_quizzes_wrong";

let allQuizzes = [];
let currentQuizIndex = 0;
let correctCount = 0;
let wrongQuizzes = [];
let isAnswered = false;

// DOM
const quizContainerEl = document.getElementById("quiz-container");
const questionTextEl = document.getElementById("question-text");
const optionsContainerEl = document.getElementById("options-container");
const nextButtonEl = document.getElementById("next-button");
const timerEl = document.getElementById("timer");
const wrongCountEl = document.getElementById("wrong-count");
const explanationAreaEl = document.getElementById("explanation-area");
const reviewButtonEl = document.getElementById("review-button");
const reviewModalEl = document.getElementById("review-modal");
const reviewListEl = document.getElementById("review-list");
const closeReviewButtonEl = document.getElementById("close-review");
const resultScreenEl = document.getElementById("result-screen");

// ------------------ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ------------------
function loadQuizzesFromLocalStorage(){const data=localStorage.getItem(STORAGE_KEY_QUIZZES);return data?JSON.parse(data):null;}
function saveQuizzesToLocalStorage(){localStorage.setItem(STORAGE_KEY_QUIZZES,JSON.stringify(allQuizzes));}
function loadProgressFromLocalStorage(){const data=localStorage.getItem(STORAGE_KEY_PROGRESS);return data?JSON.parse(data):null;}
function saveProgressToLocalStorage(){localStorage.setItem(STORAGE_KEY_PROGRESS,JSON.stringify({index:currentQuizIndex,correct:correctCount,total:allQuizzes.length}));}
function loadWrongFromLocalStorage(){const data=localStorage.getItem(STORAGE_KEY_WRONG);return data?JSON.parse(data):[];}
function saveWrongToLocalStorage(){localStorage.setItem(STORAGE_KEY_WRONG,JSON.stringify(wrongQuizzes));}

// ------------------ ì˜¤ë‹µ ë¦¬ìŠ¤íŠ¸ ë Œë” ------------------
function renderWrongList(){
    reviewListEl.innerHTML="";
    if(wrongQuizzes.length===0){const emptyMsg=document.createElement("p");emptyMsg.textContent="ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤.";reviewListEl.appendChild(emptyMsg);return;}
    wrongQuizzes.forEach((quiz,idx)=>{
        const item=document.createElement("div");
        item.className="review-item";
        const lawName=quiz.source_law_name||"ë²•ë¥  ìƒì‹";
        let html=`<strong>${idx+1}. (${lawName}) ${quiz.question}</strong><br>`;
        quiz.options.forEach((opt,i)=>{
            html+=`${i+1}) ${opt.text} ${opt.is_correct?"âœ…":"âŒ"}<br>`;
        });
        html+=`<em>í•´ì„¤: ${quiz.explanation||""}</em>`;
        item.innerHTML=html;
        item.addEventListener("click",()=>{
            currentQuizIndex=allQuizzes.findIndex(q=>q.id===quiz.id);
            reviewModalEl.style.display="none";
            showQuiz();
        });
        reviewListEl.appendChild(item);
    });
    wrongCountEl.textContent=`ì˜¤ë‹µ: ${wrongQuizzes.length}`;
}

// ------------------ í€´ì¦ˆ ë¡œë“œ ------------------
async function loadQuizzes(force_reload=false){
    wrongQuizzes=loadWrongFromLocalStorage();
    renderWrongList();
    const cachedData=loadQuizzesFromLocalStorage();
    const cachedProgress=loadProgressFromLocalStorage();
    if(cachedData && cachedProgress && cachedData.length===cachedProgress.total && !force_reload){
        allQuizzes=cachedData;currentQuizIndex=cachedProgress.index;correctCount=cachedProgress.correct;
    }else{
        questionTextEl.textContent="ğŸš€ í€´ì¦ˆ ì„œë²„ì—ì„œ ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
        try{
            const response=await fetch(QUIZ_API_URL,{cache:"no-store"});
            if(!response.ok)throw new Error(`HTTP ì˜¤ë¥˜! ìƒíƒœ: ${response.status}`);
            allQuizzes=await response.json();currentQuizIndex=0;correctCount=0;
            saveQuizzesToLocalStorage();saveProgressToLocalStorage();
        }catch(error){console.error("í€´ì¦ˆ ë¡œë“œ ì‹¤íŒ¨:",error);questionTextEl.textContent=`âŒ í€´ì¦ˆ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;timerEl.textContent="ì˜¤ë¥˜";return;}
    }
    showQuiz();
}

// ------------------ í€´ì¦ˆ í‘œì‹œ ------------------
function showQuiz(){
    if(currentQuizIndex>=allQuizzes.length){showResults();return;}
    const quiz=allQuizzes[currentQuizIndex];
    quizContainerEl.style.display='block';resultScreenEl.style.display='none';isAnswered=false;nextButtonEl.style.display='none';explanationAreaEl.style.display='none';
    const lawName=quiz.source_law_name||"ë²•ë¥  ìƒì‹";
    questionTextEl.innerHTML=`<span style="color: var(--secondary-color);">(${lawName})</span> ${quiz.question}`;
    optionsContainerEl.innerHTML='';
    quiz.options.forEach((option,index)=>{
        const button=document.createElement('button');
        button.className='option-button';
        button.textContent=`${index+1}. ${option.text}`;
        button.dataset.isCorrect=option.is_correct;
        button.addEventListener('click',()=>checkAnswer(button,quiz));
        optionsContainerEl.appendChild(button);
    });
    startTimer(quiz.timer_sec||15);
}

// ------------------ ì •ë‹µ/ì˜¤ë‹µ ì²´í¬ ------------------
function checkAnswer(button,quiz){
    if(isAnswered)return;isAnswered=true;
    const isCorrect=button.dataset.isCorrect==="true";
    if(isCorrect){correctCount++;button.classList.add("correct");}
    else{button.classList.add("wrong");if(!wrongQuizzes.find(q=>q.id===quiz.id))wrongQuizzes.push(quiz);}
    const allButtons=Array.from(optionsContainerEl.children);
    allButtons.forEach(btn=>{if(btn.dataset.isCorrect==="true")btn.classList.add("correct");});
    explanationAreaEl.textContent=isCorrect?`âœ… ì •ë‹µ!\n${quiz.explanation||""}`:`âŒ ì˜¤ë‹µ!\n${quiz.explanation||""}`;
    explanationAreaEl.style.display='block';
    nextButtonEl.style.display='inline-block';
    saveProgressToLocalStorage();saveWrongToLocalStorage();
    renderWrongList();
}

// ------------------ ë‹¤ìŒ ë¬¸ì œ ------------------
nextButtonEl.addEventListener('click',()=>{
    if(!isAnswered)return;currentQuizIndex++;showQuiz();
});

// ------------------ ê²°ê³¼ í™”ë©´ ------------------
function showResults(){
    quizContainerEl.style.display='none';resultScreenEl.style.display='block';
    resultScreenEl.innerHTML=`<h2>í€´ì¦ˆ ì™„ë£Œ!</h2><p>ì •ë‹µ: ${correctCount} / ${allQuizzes.length}</p>
        <button onclick="resetQuiz()">ìƒˆ í€´ì¦ˆ ì‹œì‘</button>
        ${wrongQuizzes.length>0?`<button onclick="reviewModalEl.style.display='block';renderWrongList();">ì˜¤ë‹µ ë³µìŠµ</button>`:""}`;
}

// ------------------ íƒ€ì´ë¨¸ ------------------
let timerInterval;
function startTimer(seconds){
    clearInterval(timerInterval);
    let remaining=seconds;timerEl.textContent=remaining;
    timerInterval=setInterval(()=>{
        remaining--;
        timerEl.textContent=remaining;
        if(remaining<=0){clearInterval(timerInterval);nextButtonEl.style.display='inline-block';}
    },1000);
}

// ------------------ ìƒˆ í€´ì¦ˆ ì‹œì‘ ------------------
function resetQuiz(){
    // ê¸°ì¡´ ì˜¤ë‹µ ê¸°ë¡ ìœ ì§€
    loadQuizzes(true);
}

// ------------------ ë¦¬ë·° ëª¨ë‹¬ ------------------
closeReviewButtonEl.addEventListener("click",()=>{reviewModalEl.style.display="none";});
reviewButtonEl.addEventListener("click",()=>{reviewModalEl.style.display="block";renderWrongList();});

// ------------------ ì´ˆê¸° ë¡œë“œ ------------------
loadQuizzes();
</script>

</body>
</html>
